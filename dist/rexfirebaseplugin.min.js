!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).rexfirebaseplugin=t();}(undefined,(function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,(n=i.key,s=void 0,"symbol"==typeof(s=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return ("string"===t?String:Number)(e)}(n,"string"))?s:String(s)),i);}var n,s;}function i(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t);}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}function a(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return !1;if(Reflect.construct.sham)return !1;if("function"==typeof Proxy)return !0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return !1}}();return function(){var r,i=s(e);if(t){var n=s(this).constructor;r=Reflect.construct(i,arguments,n);}else r=i.apply(this,arguments);return a(this,r)}}function h(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return c(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var l=function(e){return void 0===e&&(e="7.19.0"),{app:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-app.js"),database:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-database.js"),firestore:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-firestore.js")}},f=function(t){if("object"!==e(t)||null===t)return t;if(Array.isArray(t))t.length=0;else for(var r in t)delete t[r];return t},v=function(e,t){var r=function(e,t){var r=Array.isArray(e);if(void 0===t?t=r?[]:{}:f(t),r){t.length=e.length;for(var i=0,n=e.length;i<n;i++)t[i]=e[i];}else for(var s in e)t[s]=e[s];return t}(e);for(var i in t)r.hasOwnProperty(i)&&(r[i]=t[i]);return r},d=function(e){return new Promise((function(t,r){!function(e,t){for(var r=document.getElementsByTagName("script"),i=0,n=r.length;i<n;i++)if(-1!=r[i].src.indexOf(e))return void(t&&t());var s=document.createElement("script");s.setAttribute("src",e),t&&(s.onload=t),document.head.appendChild(s);}(e,t);}))},m=function(e,t){return void 0===e&&(e=0),new Promise((function(r,i){setTimeout((function(){r(t);}),e);}))},y=function e(t){return g(t)?Promise.resolve():m(10).then((function(){return e(t)}))},g=function(e){var t;for(var r in e)if(e[r]&&(t=p[r])&&!t())return !1;return !0},p={database:function(){return void 0!==firebase.database},firestore:function(){return void 0!==firebase.firestore}},I=function(e,t){return e="string"==typeof e?l(e):v(l(),e),d(e.app).then((function(){var t,r=[];for(var i in e)"app"!==i&&(t=e[i])&&r.push(d(t));return 0===r.length?Promise.resolve():Promise.all(r)})).then((function(){return y(e)})).then((function(){return void 0!==t&&firebase.initializeApp(t),Promise.resolve()}))},D=Phaser.Loader.FILE_POPULATED,k=Phaser.Utils.String.UUID,b=function(e){n(s,Phaser.Loader.File);var r=u(s);function s(e,i){return t(this,s),i.hasOwnProperty("type")||(i.type="await"),i.hasOwnProperty("url")||(i.url=""),i.hasOwnProperty("key")||(i.key=k()),r.call(this,e,i)}return i(s,[{key:"load",value:function(){if(this.state===D)this.loader.nextFile(this,!0);else {var e=this.config,t=e.callback,r=e.scope,i=this.onLoad.bind(this),n=this.onError.bind(this);t?r?t.call(r,i,n):t(i,n):this.onLoad();}}},{key:"onLoad",value:function(){this.loader.nextFile(this,!0);}},{key:"onError",value:function(){this.loader.nextFile(this,!1);}}]),s}(),R=function(e,t){return this.addFile(new b(this,{config:{callback:function(r,i){return I(e,t).then((function(){setTimeout(r,0);})).catch(i)}}})),this},P=function(){function e(){t(this,e);}return i(e,[{key:"initializeApp",value:function(e){return firebase.initializeApp(e),this}}],[{key:"register",value:function(t,r){e.prototype[t]=r;}}]),e}();function w(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var E={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,r="~";function i(){}function n(e,t,r){this.fn=e,this.context=t,this.once=r||!1;}function s(e,t,i,s,o){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new n(i,s||e,o),u=r?r+t:t;return e._events[u]?e._events[u].fn?e._events[u]=[e._events[u],a]:e._events[u].push(a):(e._events[u]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new i:delete e._events[t];}function a(){this._events=new i,this._eventsCount=0;}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(r=!1)),a.prototype.eventNames=function(){var e,i,n=[];if(0===this._eventsCount)return n;for(i in e=this._events)t.call(e,i)&&n.push(r?i.slice(1):i);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},a.prototype.listeners=function(e){var t=r?r+e:e,i=this._events[t];if(!i)return [];if(i.fn)return [i.fn];for(var n=0,s=i.length,o=new Array(s);n<s;n++)o[n]=i[n].fn;return o},a.prototype.listenerCount=function(e){var t=r?r+e:e,i=this._events[t];return i?i.fn?1:i.length:0},a.prototype.emit=function(e,t,i,n,s,o){var a=r?r+e:e;if(!this._events[a])return !1;var u,h,c=this._events[a],l=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,i),!0;case 4:return c.fn.call(c.context,t,i,n),!0;case 5:return c.fn.call(c.context,t,i,n,s),!0;case 6:return c.fn.call(c.context,t,i,n,s,o),!0}for(h=1,u=new Array(l-1);h<l;h++)u[h-1]=arguments[h];c.fn.apply(c.context,u);}else {var f,v=c.length;for(h=0;h<v;h++)switch(c[h].once&&this.removeListener(e,c[h].fn,void 0,!0),l){case 1:c[h].fn.call(c[h].context);break;case 2:c[h].fn.call(c[h].context,t);break;case 3:c[h].fn.call(c[h].context,t,i);break;case 4:c[h].fn.call(c[h].context,t,i,n);break;default:if(!u)for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c[h].fn.apply(c[h].context,u);}}return !0},a.prototype.on=function(e,t,r){return s(this,e,t,r,!1)},a.prototype.once=function(e,t,r){return s(this,e,t,r,!0)},a.prototype.removeListener=function(e,t,i,n){var s=r?r+e:e;if(!this._events[s])return this;if(!t)return o(this,s),this;var a=this._events[s];if(a.fn)a.fn!==t||n&&!a.once||i&&a.context!==i||o(this,s);else {for(var u=0,h=[],c=a.length;u<c;u++)(a[u].fn!==t||n&&!a[u].once||i&&a[u].context!==i)&&h.push(a[u]);h.length?this._events[s]=1===h.length?h[0]:h:o(this,s);}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&o(this,t)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,e.exports=a;}(E);var x=w(E.exports),N={setEventEmitter:function(e,t){return void 0===t&&(t=x),this._privateEE=!0===e||void 0===e,this._eventEmitter=this._privateEE?new t:e,this},destroyEventEmitter:function(){return this._eventEmitter&&this._privateEE&&this._eventEmitter.removeAllListeners(),this},getEventEmitter:function(){return this._eventEmitter},on:function(){return this._eventEmitter&&this._eventEmitter.on.apply(this._eventEmitter,arguments),this},once:function(){return this._eventEmitter&&this._eventEmitter.once.apply(this._eventEmitter,arguments),this},off:function(){return this._eventEmitter&&this._eventEmitter.off.apply(this._eventEmitter,arguments),this},emit:function(e){return this._eventEmitter&&e&&this._eventEmitter.emit.apply(this._eventEmitter,arguments),this},addListener:function(){return this._eventEmitter&&this._eventEmitter.addListener.apply(this._eventEmitter,arguments),this},removeListener:function(){return this._eventEmitter&&this._eventEmitter.removeListener.apply(this._eventEmitter,arguments),this},removeAllListeners:function(){return this._eventEmitter&&this._eventEmitter.removeAllListeners.apply(this._eventEmitter,arguments),this},listenerCount:function(){return this._eventEmitter?this._eventEmitter.listenerCount.apply(this._eventEmitter,arguments):0},listeners:function(){return this._eventEmitter?this._eventEmitter.listeners.apply(this._eventEmitter,arguments):[]},eventNames:function(){return this._eventEmitter?this._eventEmitter.eventNames.apply(this._eventEmitter,arguments):[]}},F=function(e,t,r){if(e&&"number"!=typeof e){if(e.hasOwnProperty(t))return e[t];if(-1!==t.indexOf(".")){for(var i=t.split("."),n=e,s=r,o=0;o<i.length;o++){if(!n.hasOwnProperty(i[o])){s=r;break}s=n[i[o]],n=n[i[o]];}return s}return r}return r},U=function(t){if("object"!==e(t)||t.nodeType||t===t.window)return !1;try{if(t.constructor&&!{}.hasOwnProperty.call(t.constructor.prototype,"isPrototypeOf"))return !1}catch(e){return !1}return !0},L={startReceiving:function(){return this.isReceiving&&this.receiverRef.key===this.receiverID||(this.stopReceiving(),this.isReceiving=!0,this.skipFirst=!0,this.receiverRef=this.database.ref(this.rootPath).child(this.receiverID),this.receiverRef.on("value",_,this),this.receiverRef.onDisconnect().remove()),this},stopReceiving:function(){return this.isReceiving?(this.isReceiving=!1,this.receiverRef.off("value",_,this),this.receiverRef.remove(),this.receiverRef.onDisconnect().cancel(),this):this}},_=function(e){if(this.skipFirst)this.skipFirst=!1;else {var t=e.val();null!=t&&(delete t.stamp,this.history.add(t),this.emit(this.eventNameMap.receive,t));}},C=function(){function e(r){t(this,e),this.maxLength=F(r,"maxLength",-1),this.records=[];}return i(e,[{key:"add",value:function(e){return 0===this.maxLength||(this.records.push(e),this.maxLength>0&&this.records.length>this.maxLength&&this.records.shift()),this}},{key:"clear",value:function(){return this.records.length=0,this}},{key:"changeUserName",value:function(e,t){return 0===this.maxLength||this.records.forEach((function(r){r.senderID===e&&(r.senderName=t);})),this}}]),e}(),j=function(){function e(r){t(this,e);var i=F(r,"eventEmitter",void 0),n=F(r,"EventEmitterClass",void 0);this.setEventEmitter(i,n),this.eventNameMap=F(r,"eventNames",A),this.database=firebase.database(),this.setRootPath(F(r,"root","")),this.skipFirst=!0,this.stamp=!1,this.userInfo={userID:"",userName:void 0},this.setSender(F(r,"senderID",""),F(r,"senderName","")),this.setReceiver(F(r,"receiverID","")),this.isReceiving=!1;var s=F(r,"history",0);!0===s?s=-1:!1===s&&(s=0),this.history=new C({maxLength:s});}return i(e,[{key:"shutdown",value:function(){this.stopReceiving().destroyEventEmitter();}},{key:"destroy",value:function(){this.shutdown();}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e;}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e;}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.sendToRef=void 0,this.receiverRef=void 0,this}},{key:"setSender",value:function(e,t){return U(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setReceiver",value:function(e){return this.receiverID=e,this}},{key:"changeUserName",value:function(e,t){return e===this.userID&&(this.userName=t),this.history.changeUserName(e,t),this}},{key:"getHistory",value:function(){return this.history.records}},{key:"clearHistory",value:function(){return this.history.clear(),this}}]),e}(),M={send:function(e){if(this.sendToRef&&this.sendToRef.key===this.receiverID||(this.sendToRef=this.database.ref(this.rootPath).child(this.receiverID)),void 0===e)return this.sendToRef.remove();var t={message:e,senderID:this.userID,stamp:this.stamp};return void 0!==this.userName&&(t.senderName=this.userName),this.skipFirst=!1,this.stamp=!this.stamp,this.sendToRef.set(t)}};Object.assign(j.prototype,N,L,M);var A={receive:"receive"},O=function(e){return null==e||""===e||0===e.length},Q=function(t,r,i,n){if(void 0===n&&(n="."),"object"===e(t)){if(O(r)){if(null==i)return;"object"===e(i)&&(t=i);}else {"string"==typeof r&&(r=r.split(n));var s=r.pop(),o=function(t,r,i){var n=t;if(O(r));else {var s;"string"==typeof r&&(r=r.split("."));for(var o=0,a=r.length;o<a;o++){var u;null!=n[s=r[o]]&&"object"===e(n[s])||(u=o===a-1?void 0===i?{}:i:{},n[s]=u),n=n[s];}}return n}(t,r);o[s]=i;}return t}};P.register("broadcast",(function(e){return new j(e)})),Q(window,"RexPlugins.Fire.Broadcast",j);var T={clear:function(){return this.items.length=0,f(this.itemID2Index),this},getItems:function(){return this.items},hasItem:function(e){return this.itemID2Index.hasOwnProperty(e)},getItemIndexFromItemID:function(e){return null==e?null:this.itemID2Index[e]},getItemFromItemID:function(e){if(null==e)return null;var t=this.getItemIndexFromItemID(e);return null==t?null:this.items[t]},forEach:function(e,t){return this.items.forEach(e,t),this},updateItemID2Index:function(){var e;f(this.itemID2Index);for(var t=0,r=this.items.length;t<r;t++)e=this.items[t][this.keyItemID],this.itemID2Index[e]=t;return this}},S=function(e,t){var r=z.call(this,e,t);this.updateItemID2Index(),this.emit(this.eventNameMap.add,r),this.emit(this.eventNameMap.update,this.items);},B=function(e,t){var r=H.call(this,e);this.updateItemID2Index();var i=z.call(this,e,t);this.updateItemID2Index(),this.emit(this.eventNameMap.change,i,r),this.emit(this.eventNameMap.update,this.items);},K=function(e){var t=H.call(this,e);this.updateItemID2Index(),this.emit(this.eventNameMap.remove,t),this.emit(this.eventNameMap.update,this.items);},q=function(e){this.clear(),e.forEach(function(e){z.call(this,e,null,!0);}.bind(this)),this.updateItemID2Index(),this.emit(this.eventNameMap.update,this.items);},z=function(e,t,r){var i,n=this.getItemCallback,s=this.getItemCallbackScope;if(i=s?n.call(s,e):n(e),r)return this.items.push(i),i;if(null==t)this.items.unshift(i);else {var o=this.itemID2Index[t];o===this.items.length-1?this.items.push(i):this.items.splice(o+1,0,i);}return i},H=function(e){var t=this.itemID2Index[e.key],r=function(e,t){if(!(t>=e.length)){for(var r=e.length-1,i=e[t],n=t;n<r;n++)e[n]=e[n+1];return e.length=r,i}}(this.items,t);return r},V={start:function(e){return this.isUpdating=!1,e.once("value",q,this),this},stop:function(){return this}},W={start:function(e){return e.on("child_added",S,this),e.on("child_removed",K,this),e.on("child_moved",B,this),e.on("child_changed",B,this),this},stop:function(){return this.query.off("child_added",S,this),this.query.off("child_removed",K,this),this.query.off("child_moved",B,this),this.query.off("child_changed",B,this),this}},Y={start:function(e){return e.on("value",q,this),this},stop:function(){return this.query.off("value",q,this),this}},G=function(){function e(r){t(this,e);var i=F(r,"eventEmitter",void 0),n=F(r,"EventEmitterClass",void 0);this.setEventEmitter(i,n),this.eventNameMap=F(r,"eventNames",X),this.isUpdating=!1,this.items=[],this.itemID2Index={},this.setItemIDKey(F(r,"itemIDKey","__itemID__")),this.setMode(F(r,"mode",1)),this.setGetitemCallback(F(r,"getItemCallback",J),F(r,"getItemCallbackScope",this)),this.setQuery(F(r,"query",void 0));}return i(e,[{key:"shutdown",value:function(){this.stopUpdate().clear();}},{key:"destroy",value:function(){this.shutdown();}},{key:"setItemIDKey",value:function(e){return this.keyItemID=e,this}},{key:"setMode",value:function(e){return "string"==typeof e&&(e=$[e]),this.mode=e,this.updater=Z[e],this}},{key:"setGetitemCallback",value:function(e,t){return this.getItemCallback=e,this.getItemCallbackScope=t,this}},{key:"setQuery",value:function(e){return this.query=e,this}},{key:"startUpdate",value:function(e){if(e)this.setQuery(e);else {if(!this.query)return this;e=this.query;}return this.stopUpdate().clear(),this.isUpdating=!0,this.updater.start.call(this,e),this}},{key:"stopUpdate",value:function(){return this.query&&this.isUpdating?(this.isUpdating=!1,this.updater.stop.call(this),this):this}}]),e}(),J=function(e){var t=e.val();return t[this.keyItemID]=e.key,t};
/**
   * @author       Richard Davey <rich@photonstorm.com>
   * @copyright    2018 Photon Storm Ltd.
   * @license      {@link https://github.com/photonstorm/phaser/blob/master/license.txt|MIT License}
   */Object.assign(G.prototype,N,T);var X={update:"update",add:"add",remove:"remove",change:"change"},Z={0:V,1:W,2:Y},$={once:0,child:1,all:2},ee=function(e,t){var r=!1;return e.forEach((function(e){if(e.val().userID===t)return r=!0,!0})),r},te=function(){function e(r){t(this,e);var i=F(r,"eventEmitter",void 0),n=F(r,"EventEmitterClass",void 0);this.setEventEmitter(i,n),this.database=firebase.database(),this.setRootPath(F(r,"root","")),this.userInfo={userID:"",userName:""},this.setUser(F(r,"userID",""),F(r,"userName","")),this.setMaxUsers(F(r,"maxUsers",0)),this.userList=new G({eventEmitter:this.getEventEmitter(),itemIDKey:"joinAt",eventNames:{add:F(r,"eventNames.join","join"),remove:F(r,"eventNames.leave","leave"),update:F(r,"eventNames.update","update"),change:F(r,"eventNames.change","change"),init:F(r,"eventNames.init","init"),changename:F(r,"eventNames.changename","changename")}}),this.isInList=!1,this.userID2ItemID={},this.userList.on(this.userList.eventNames.add,(function(e){this.userID2ItemID[e.userID]=e.joinAt,e.userID===this.userInfo.userID&&this.emit(this.userList.eventNames.init,this.getUsers());}),this).on(this.userList.eventNames.remove,(function(e){delete this.userID2ItemID[e.userID],e.userID===this.userID&&(this.isInList=!1);}),this).on(this.userList.eventNames.change,(function(e,t){var r=e.userID,i=e.userName,n=t.userName;i!==n&&this.emit(this.userList.eventNames.changename,r,i,n);}),this);}return i(e,[{key:"shutdown",value:function(){this.stopUpdate().destroyEventEmitter().leave(),this.userList.shutdown();}},{key:"destroy",value:function(){this.shutdown();}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e;}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e;}},{key:"setRootPath",value:function(e){return this.rootPath=e,this}},{key:"rootRef",get:function(){return this.database.ref(this.rootPath)}},{key:"setUser",value:function(e,t){return U(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setMaxUsers",value:function(e){return this.maxUsers=e,this}},{key:"clear",value:function(){return this.userList.clear(),this}},{key:"forEach",value:function(e,t){return this.userList.forEach(e,t),this}},{key:"isFull",value:function(){return 0!==this.maxUsers&&this.userList.getItems().length>=this.maxUsers}},{key:"isFirstUser",value:function(e){void 0===e&&(e=this.userID);var t=this.usersList.getItems()[0];return t&&t.userID===e}},{key:"getUser",value:function(e){if(void 0===e&&(e=this.userID),!this.contains(e))return null;var t=this.userID2ItemID[e];return this.userList.getItemFromItemID(t)}},{key:"getUsers",value:function(){return this.userList.getItems()}},{key:"getUserRef",value:function(e){if(void 0===e&&(e=this.userID),!this.contains(e))return null;var t=this.userID2ItemID[e];return this.rootRef.child(t)}},{key:"contains",value:function(e){return void 0===e&&(e=this.userID),this.userID2ItemID.hasOwnProperty(e)}},{key:"startUpdate",value:function(){var e=this.database.ref(this.rootPath);return this.maxUsers>0&&(e=e.limitToFirst(this.maxUsers)),this.userList.startUpdate(e),this}},{key:"stopUpdate",value:function(){return this.userList.stopUpdate(),this}}]),e}(),re={join:function(e,t){if(void 0===e&&(e=this.userID,t=this.userName),this.contains(e))return Promise.resolve();var r={userID:e,userName:t},i=this.maxUsers,n=this.database.ref(this.rootPath),s=n.push();return s.onDisconnect().remove().then((function(){return s.set(r)})).then((function(){return m(0)})).then((function(){return 0===i?(self.isInList=!0,Promise.resolve()):n.limitToFirst(i).once("value").then((function(t){return ee(t,e)?(self.isInList=!0,Promise.resolve()):(self.isInList=!1,s.remove().then((function(){return s.onDisconnect().cancel()})).then((function(){return Promise.reject()})))}))}))},leave:function(e){if(void 0===e&&(e=this.userID),!this.contains(e))return Promise.resolve();var t=this.userID2ItemID[e];return this.database.ref(this.rootPath).child(t).remove()},changeUserName:function(e){var t=this;return new Promise((function(e,r){var i=t.getUserRef();i?e(i):t.rootRef.orderByChild("userID").equalTo(t.userID).once("child_added").then((function(t){e(t.ref);}));})).then((function(t){return t.child("userName").set(e)})).then((function(){return t.userName=e,Promise.resolve()}))}};Object.assign(te.prototype,N,re),P.register("onlineUserList",(function(e){return new te(e)})),Q(window,"RexPlugins.Fire.OnlineUserList",te);var ie=function(e){var t=new te({eventEmitter:this.getEventEmitter(),eventNames:{join:"userlist.join",leave:"userlist.leave",update:"userlist.update",change:"userlist.change",init:"userlist.init",changename:"userlist.changename"},userID:this.userInfo});return t.on("userlist.leave",(function(e){e.userID===this.userID&&ne.call(this);}),this),this.on("room.join",(function(){t.startUpdate();})).on("room.leave",(function(){t.stopUpdate().clear();})),t},ne=function(){this.emit("room.leave");var e=this;setTimeout((function(){e.roomID=void 0,e.roomName=void 0,e.doorState=void 0,e.leftRoomFlag=!1;}),0);},se=function(e){return new G({eventEmitter:this.getEventEmitter(),root:this.getRoomFilterRef(),itemIDKey:"roomID",eventNames:{update:"roomlist.update",add:"roomlist.add",remove:"roomlist.remove",change:"roomlist.change"},mode:"once"})},oe=function(e){var t=F(e,"broadcast",!0);if(!t)return null;var r=new j({eventEmitter:this.getEventEmitter(),eventNames:{receive:"broadcast.receive"},receiverID:"boradcast",senderID:this.userInfo,history:F(t,"history",!1)});return this.on("room.join",(function(e){r.setRootPath(this.getRoomDataPath(e.roomID)).startReceiving();}),this).on("room.leave",(function(){r.stopReceiving();}),this).on("userlist.changename",(function(e,t){r.changeUserName(e,t);}),this),r},ae=function t(r){var i,n,s;if(null==r||"object"!==e(r))return r;if(i=Array.isArray(r)?[]:{},U(r))for(s in r)n=r[s],i[s]=t(n);else i=r;return i},ue=function(){function e(r){t(this,e),void 0===r&&(r={}),this.data=r,this.refPath="";}return i(e,[{key:"getFullPath",value:function(e){if("string"==typeof e)if("."===e)e=this.refPath;else if(e.startsWith(".."))if(""!==this.refPath){var t=this.refPath.split(".");t.pop(),e="".concat(t.join(".")).concat(e.substring(1));}else e=e.substring(2);else e.startsWith(".")&&(e=""!==this.refPath?"".concat(this.refPath).concat(e):e.substring(1));return e}},{key:"setRefPath",value:function(e){return void 0===e&&(e=""),this.refPath=this.getFullPath(e),this}},{key:"setValue",value:function(e,t){return void 0===e?this.clear():void 0===t?this.data=e:Q(this.data,this.getFullPath(e),t),this}},{key:"getValue",value:function(e){return void 0===e?this.data:("string"==typeof e&&(e=this.getFullPath(e).split(".")),ce(this.data,e))}},{key:"cloneValue",value:function(e){return ae(this.getValue(e))}},{key:"removeKey",value:function(e){if(void 0===e)this.clear();else {"string"==typeof e&&(e=this.getFullPath(e).split("."));var t=e.pop(),r=ce(this.data,e);he(r)&&delete r[t];}return this}},{key:"hasKey",value:function(e){"string"==typeof e&&(e=this.getFullPath(e).split("."));var t=e.pop(),r=ce(this.data,e);return !!he(r)&&r.hasOwnProperty(t)}},{key:"clear",value:function(){return f(this.data),this}},{key:"clone",value:function(t){var r=new e(t?this.cloneValue():this.data);return r.setRefPath(this.refPath),r}}]),e}(),he=function(t){return null!=t&&"object"===e(t)},ce=function(e,t){if(""===t[0])return e;for(var r=e,i=0,n=t.length;i<n;i++){if(!he(r))return;r=r[t[i]];}return r},le=function(){function e(r){t(this,e),this.setEventEmitter(r.eventEmitter,r.EventEmitterClass),this.parent=r.parent,this.key=r.key,this.parent?this.fullKeyPath=fe(this.parent.fullKeyPath,this.key):this.fullKeyPath="",this.type=r.type,this.eventNameMap=r.eventNames,this.table=r.table,this.database=firebase.database(),this.setRootPath(),this.children={};}return i(e,[{key:"shutdown",value:function(){this.stopUpdate().clear().destroyEventEmitter();}},{key:"destroy",value:function(){this.shutdown();}},{key:"setRootPath",value:function(t){if(void 0===t){var r=this.parent?this.parent.rootPath:"";t="".concat(r,"/").concat(this.key);}var i;for(var n in this.rootPath=t,this.children)(i=this.children[n])instanceof e&&i.setRootPath();return this}},{key:"rootRef",get:function(){return this.database.ref(this.rootPath)}},{key:"load",value:function(){var e=this;return this.rootRef.once("value").then((function(t){var r=t.val()||{};return e.table.setValue(r),Promise.resolve(r)}))}},{key:"setData",value:function(e,t){if(void 0===e)this.clear();else if(void 0===t){var r=e;for(e in this.children)r.hasOwnProperty(e)||this.removeChild(e);for(e in r)this.setChildData(e,r[e]);}else this.setChildData(e,t);return this}},{key:"clear",value:function(){for(var e in this.table.removeKey(this.fullKeyPath),this.children)this.removeChild(e);return this}},{key:"childClass",get:function(){}},{key:"setChildData",value:function(e,t){var r=fe(this.fullKeyPath,e);if(this.table.setValue(r,t),this.children.hasOwnProperty(e))this.children[e].setData(t);else if(this.childClass){var i=new this.childClass({parent:this,key:e,type:this.type,eventEmitter:this.getEventEmitter(),eventNames:this.eventNameMap,table:this.table});i.startUpdate(),this.children[e]=i;}return this}},{key:"removeChild",value:function(e){return this.children.hasOwnProperty(e)&&(this.children[e].destroy(),delete this.children[e]),this}},{key:"startUpdate",value:function(){}},{key:"stopUpdate",value:function(){}}]),e}(),fe=function(e,t){return null==e||""===e?t:null==t||""===t?e:"".concat(e,".").concat(t)};Object.assign(le.prototype,N);var ve=function(e){n(s,e);var r=u(s);function s(){return t(this,s),r.apply(this,arguments)}return i(s,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addCol,this),this.rootRef.on("child_removed",this.removeCol,this),this.rootRef.on("child_changed",this.changeColValue,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addCol,this),this.rootRef.off("child_removed",this.removeCol,this),this.rootRef.off("child_changed",this.changeColValue,this),this}},{key:"addCol",value:function(e){var t=e.key,r=e.val();switch(this.setData(t,r),this.type){case 1:this.emit(this.eventNameMap.addkey0,t,r);break;case 2:this.emit(this.eventNameMap.addkey1,this.key,t,r);break;default:this.emit(this.eventNameMap.addkey2,this.pageKey,this.key,t,r);}this.emit(this.eventNameMap.update,this.table.data);}},{key:"removeCol",value:function(e){var t=e.key;switch(this.removeChild(t),this.type){case 1:this.emit(this.eventNameMap.removekey0,t);break;case 2:this.emit(this.eventNameMap.removekey1,this.key,t);break;default:this.emit(this.eventNameMap.removekey2,this.pageKey,this.key,t);}this.emit(this.eventNameMap.update,this.table.data);}},{key:"changeColValue",value:function(e){var t=e.key,r=e.val();switch(this.setData(t,r),this.type){case 1:this.emit(this.eventNameMap.changekey0,t,r);break;case 2:this.emit(this.eventNameMap.changekey1,this.key,t,r);break;default:this.emit(this.eventNameMap.changekey2,this.pageKey,this.key,t,r);}this.emit(this.eventNameMap.update,this.table.data);}},{key:"pageKey",get:function(){return this.parent.key}}]),s}(le),de=function(e){n(s,e);var r=u(s);function s(){return t(this,s),r.apply(this,arguments)}return i(s,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addRow,this),this.rootRef.on("child_removed",this.removeRow,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addRow,this),this.rootRef.off("child_removed",this.removeRow,this),this}},{key:"addRow",value:function(e){var t=e.key,r=e.val();if(this.setData(t,r),2===this.type)this.emit(this.eventNameMap.addkey0,this.key,t,r);else this.emit(this.eventNameMap.addkey1,this.key,t,r);}},{key:"removeRow",value:function(e){var t=e.key;if(this.removeChild(t),2===this.type)this.emit(this.eventNameMap.removekey0,t);else this.emit(this.eventNameMap.removekey1,this.key,t);}},{key:"childClass",get:function(){return ve}},{key:"pageKey",get:function(){return this.parent.key}}]),s}(le),me=function(e){n(s,e);var r=u(s);function s(e){return t(this,s),r.call(this,e)}return i(s,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addPage,this),this.rootRef.on("child_removed",this.removePage,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addPage,this),this.rootRef.off("child_removed",this.removePage,this),this}},{key:"addPage",value:function(e){var t=e.key,r=e.val();this.setData(t,r),this.emit(this.eventNameMap.addkey0,t,r);}},{key:"removePage",value:function(e){var t=e.key;this.removeChild(t),this.emit(this.eventNameMap.removekey0,t);}},{key:"childClass",get:function(){return de}}]),s}(le),ye=function(){var e=this;return this.initialFlag=!1,this.updater.clear().load().then((function(t){return e.initialFlag=!0,e.emit(e.eventNames.init,t),Promise.resolve(t)}))},ge=function(){function e(r){t(this,e);var i=F(r,"eventEmitter",void 0),n=F(r,"EventEmitterClass",void 0);this.setEventEmitter(i,n),this.eventNameMap=F(r,"eventNames",ke),this.database=firebase.database(),this.table=new ue,this.setTableType(F(r,"type",3)),this.setRootPath(F(r,"root","")),this.initialFlag=!1;}return i(e,[{key:"shutdown",value:function(){this.updater.destroy(),this.destroyEventEmitter().stopUpdate();}},{key:"destroy",value:function(){this.shutdown();}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.updater.setRootPath(e),this}},{key:"setTableType",value:function(e){"string"==typeof e&&(e=De[e]),this.tableType=e;var t=pe[e];return this.updater=new t({type:e,eventEmitter:this.getEventEmitter(),eventNames:this.eventNameMap,table:this.table}),this}},{key:"getRootRef",value:function(){return this.database.ref(this.rootPath)}},{key:"getRef",value:function(e,t,r){var i=this.getRootRef();return i=e?i.child(e):i,i=t?i.child(t):i,i=r?i.child(r):i}},{key:"startUpdate",value:function(){return ye.call(this),this.updater.startUpdate(),this}},{key:"stopUpdate",value:function(){return this.updater.stopUpdate(),this}},{key:"clear",value:function(){return this.updater.clear(),this}},{key:"getData",value:function(){return this.table.getValue(arguments)}},{key:"cloneData",value:function(){return this.table.cloneValue(arguments)}}]),e}(),pe={1:ve,2:de,3:me},Ie={setData:function(){var e,t,r,i;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);e=n[0],t=n[1],r=n[2],i=n[3];break;case 3:var s=Array.prototype.slice.call(arguments);e=s[0],t=s[1],i=s[2];break;case 2:var o=Array.prototype.slice.call(arguments);e=o[0],i=o[1];break;default:i=arguments[0];}return this.getRef(e,t,r).set(i)},removeData:function(){var e,t,r;switch(arguments.length){case 3:var i=Array.prototype.slice.call(arguments);e=i[0],t=i[1],r=i[2];break;case 2:var n=Array.prototype.slice.call(arguments);e=n[0],t=n[1];break;default:e=arguments[0];}return this.getRef(e,t,r).remove()},incValue:function(){var e,t,r,i;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);e=n[0],t=n[1],r=n[2],i=n[3];break;case 3:var s=Array.prototype.slice.call(arguments);e=s[0],t=s[1],i=s[2];break;case 2:var o=Array.prototype.slice.call(arguments);e=o[0],i=o[1];break;default:i=arguments[0];}return this.getRef(e,t,r).transaction((function(e){return null===e&&(e=0),e+i}))},transaction:function(){var e,t,r,i;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);e=n[0],t=n[1],r=n[2],i=n[3];break;case 3:var s=Array.prototype.slice.call(arguments);e=s[0],t=s[1],i=s[2];break;case 2:var o=Array.prototype.slice.call(arguments);e=o[0],i=o[1];break;default:i=arguments[0];}return this.getRef(e,t,r).transaction(i)},updateData:function(e){return this.getRef().update(e)},removeDataOnDisconnect:function(){var e,t,r;switch(arguments.length){case 3:var i=Array.prototype.slice.call(arguments);e=i[0],t=i[1],r=i[2];break;case 2:var n=Array.prototype.slice.call(arguments);e=n[0],t=n[1];break;case 1:e=arguments[0];}return this.getRef(e,t,r).onDisconnect().remove()},setDataOnDisconnect:function(){var e,t,r,i;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);e=n[0],t=n[1],r=n[2],i=n[3];break;case 3:var s=Array.prototype.slice.call(arguments);e=s[0],t=s[1],i=s[2];break;case 2:var o=Array.prototype.slice.call(arguments);e=o[0],i=o[1];break;default:i=arguments[0];}return this.getRef(e,t,r).onDisconnect().set(i)}};Object.assign(ge.prototype,N,Ie);var De={"1d":1,"2d":2,"3d":3},ke={init:"init",update:"update",addkey0:"addkey0",removekey0:"removekey0",changekey0:"changekey0",addkey1:"addkey1",removekey1:"removekey1",changekey1:"changekey1",addkey2:"addkey2",removekey2:"removekey2",changekey2:"changekey2"},be=function(e){var t,r=F(e,"tables",void 0);if(void 0===r)return {};for(var i={},n=0,s=r.length;n<s;n++)i[(t=r[n]).key]=Re.call(this,t);return i},Re=function(e){var t=e.key,r=new ge({eventEmitter:this.getEventEmitter(),root:this.getItemTablePath(this.roomID,t),type:F(e,"type",1),eventNames:{init:"tables.".concat(t,".init"),update:"tables.".concat(t,".update"),addkey0:"tables.".concat(t,".addkey0"),removekey0:"tables.".concat(t,".removekey0"),changekey0:"tables.".concat(t,".changekey0"),addkey1:"tables.".concat(t,".addkey1"),removekey1:"tables.".concat(t,".removekey1"),changekey1:"tables.".concat(t,".changekey1"),addkey2:"tables.".concat(t,".addkey2"),removekey2:"tables.".concat(t,".removekey2"),changekey2:"tables.".concat(t,".changekey2")}});return this.on("room.join",(function(){r.startUpdate();})).on("room.leave",(function(){r.clear().stopUpdate();})),r},Pe=function(e,t){return void 0===t&&(t=""),"".concat(e,"|").concat(t)},we=function(e){this.roomID=e.roomID,this.roomName=e.roomName,this.roomType=e.roomType,this.emit("room.join",e);},Ee=function(e){return this.getRoomAliveRef(e).transaction((function(e){return null===e||void 0}))},xe=function(e){var t=(e=v(Ne,e)).roomID,r=e.roomName,i=e.roomType,n=e.door,s=e.join,o=e.filterData,a=this.getRoomRef(t),u=this.getRoomFilterRef(t),h=this.getRoomDataRef(t);this.isRemoveRoomWhenLeft=!e.presisted,this.isRemoveRoomWhenLeft&&(a.onDisconnect().remove(),u.onDisconnect().remove(),h.onDisconnect().remove());var c=Pe(n,i),l={},f={filter:c,name:r};o&&(f.data=o),l["room-filters/".concat(t)]=f;var d={name:r,filter:c,maxUsers:e.maxUsers,moderators:{}};d.moderators[this.userID]=this.userName,l["room-data/".concat(t)]=d;var m=this;return new Promise((function(r,i){if(s){var n=m.userList.setRootPath(m.getUserListPath(t)).setMaxUsers(0).join();return m.userList.setMaxUsers(e.maxUsers),n.then(r,i)}return r()})).then((function(){return m.getRootRef().update(l)})).then((function(){return m.isRoomCreator=!0,s&&we.call(m,e),Promise.resolve(e)}))},Ne={roomID:"",roomName:"",roomType:"",maxUsers:0,presisted:!1,door:"open",join:!0,filterData:void 0},Fe=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=e.length);var i=t+Math.floor(Math.random()*r);return void 0===e[i]?null:e[i]},Ue=function(e,t,r){void 0===r&&(r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var i=void 0===t?e:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)}(e,t),n="",s=0;s<i;s++)n+=Fe(r);return n},Le=function e(t,r,i,n){if(n.roomID=Ue(t,t,r),i<=0)return Promise.reject(n);i--;var s=this;return this.createRoom(n).catch((function(){return e.call(s,t,r,i,n)}))},_e=function(e){if(void 0===F(e,"roomID",void 0))return Promise.reject();this.isRemoveRoomWhenLeft=!1;var t=this;return Ce.call(t,e).then((function(r){return t.userList.setRootPath(t.getUserListPath(e.roomID)).setMaxUsers(r.maxUsers).join()})).then((function(){return we.call(t,e),Promise.resolve(e)}))},Ce=function(e){var t=this;return this.getRoomDataRef(e.roomID).once("value").then((function(r){var i=r.val();return null===i?Promise.reject():(e.roomName=i.name,e.roomType=i.filter.split("|")[1],t.isRoomOpened(i)?Promise.resolve(i):Promise.reject())}))},je=function e(t,r,i){if(i===r.length)return Promise.reject();t.roomID=r[i].roomID,i++;var n=this;return this.joinRoom(t).catch((function(){return e.call(n,t,r,i)}))},Me={getRootRef:function(e){var t=this.database.ref(this.rootPath);return e&&(t=t.child(e)),t},getRoomRef:function(e,t){var r=this.getRootRef("rooms");return void 0!==e&&(r=r.child(e),void 0!==t&&(r=r.child(t))),r},getRoomAliveRef:function(e){return this.getRoomRef(e,"alive")},getUserListRef:function(e){return this.getRoomRef(e,"users")},getRoomFilterRef:function(e){var t=this.getRootRef("room-filters");return void 0!==e&&(t=t.child(e)),t},getRoomDataRef:function(e){var t=this.getRootRef("room-data");return void 0!==e&&(t=t.child(e)),t},getUserDataRef:function(e){var t=this.getRootRef("user-data");return void 0!==e&&(t=t.child(e)),t},getRoomDataPath:function(e,t){var r="".concat(this.rootPath,"/rooms/").concat(e);return t&&(r+="/".concat(t)),r},getUserListPath:function(e){return this.getRoomDataPath(e,"users")},getItemTablePath:function(e,t){return "".concat(this.getRoomDataPath(e,"tables"),"/").concat(t)},getRoomListQuery:function(e,t){void 0===t&&(t="open");var r=this.getRoomFilterRef();return r=r.orderByChild("filter"),r=void 0===e?r.startAt(t).endAt("".concat(t,"~")):r.equalTo(Pe(t,e))}},Ae={createRoom:function(e){void 0===e&&(e={}),null==e.roomID&&(e.roomID=this.getRoomRef().push().key);var t=this;return Ee.call(t,e.roomID).then((function(){return xe.call(t,e)}))},createRandomRoom:function(e){void 0===e&&(e={});var t=F(e,"digits",10),r=F(e,"candidates","0123456789"),i=F(e,"retry",1e3);return Le.call(this,t,r,i,e)},joinRoom:function(e){var t=F(e,"leftThenJoin",!0),r=this;return t?this.leaveRoom().then((function(){return _e.call(r,e)})):_e.call(r,e)},joinRandomRoom:function(e){void 0===e&&(e={});var t=F(e,"roomType",""),r=F(e,"door","open"),i=this;return this.getRoomList(t,r).then((function(t){return function(e){for(var t=e.length-1;t>0;t--){var r=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[r],e[r]=i;}}(t),je.call(i,e,t,0)}))},leaveRoom:function(){if(!this.isInRoom())return Promise.resolve();if(this.leftRoomFlag=!0,this.isRemoveRoomWhenLeft)return this.removeRoom();var e=this.getRoomInfo();return this.userList.leave().then((function(){return Promise.resolve(e)}))},removeRoom:function(e){if(void 0===e&&(e=this.roomID),void 0===e)return Promise.resolve();var t={};t["room-filter/".concat(e)]=null,t["room-data/".concat(e)]=null,t["rooms/".concat(e)]=null;var r=this.getRoomInfo();return this.getRootRef().update(t).then((function(){return Promise.resolve(r)}))},kickUser:function(e){return this.userList.contains(e)?e===this.userID?this.leaveRoom():this.userList.leave(e):Promise.resolve()},isRoomOpened:function(e){if(null==e)return !1;if("closed"===e.filter.split("|")[0])return !1;var t=this.userID;if(e.moderators.hasOwnProperty(t))return !0;switch(e.permission){case"black-list":var r=e["black-list"];return !(r&&r.hasOwnProperty(t));case"white-list":var i=e["white-list"];return i&&i.hasOwnProperty(t);default:return !0}},changeRoomState:function(e,t){1===arguments.length&&(t=e,e=void 0),void 0===e&&(e=this.roomID);var r=this;return this.hasRoom(e).then((function(i){if(!i)return Promise.resolve();var n=Pe(t,r.roomType),s={};return s["room-filters/".concat(e,"/filter")]=n,s["room-data/".concat(e,"/filter")]=n,r.getRootRef().update(s)}))},changeFilterData:function(e,t){1===arguments.length&&(t=e,e=void 0),void 0===e&&(e=this.roomID);var r=this;return this.hasRoom(e).then((function(i){return i?r.getRoomFilterRef(e).child("data").update(t):Promise.resolve()}))},changeUserName:function(e){return this.userList.changeUserName(e)},changeRoomName:function(e,t){1===arguments.length&&(t=e,e=void 0),void 0===e&&(e=this.roomID);var r=this;return this.hasRoom(e).then((function(i){if(!i)return Promise.resolve();var n={};return n["room-filters/".concat(e,"/name")]=t,n["room-data/".concat(e,"/name")]=t,r.getRootRef().update(n)}))},openRoom:function(e){return this.setRoomState(e,"open")},closeRoom:function(e){return this.setRoomState(e,"closed")},getUserList:function(e){if(void 0===e)return this.userList.getUsers();var t=this;return new Promise((function(r,i){new G({itemIDKey:"joinAt",mode:"once"}).once("update",(function(e){r(e);})).startUpdate(t.getUserListRef(e));}))},getRoomList:function(e,t){var r=this;return new Promise((function(i,n){r.roomList.once("roomlist.update",(function(e){i(e);})).startUpdate(r.getRoomListQuery(e,t));}))},hasRoom:function(e){return e===this.roomID?Promise.resolve(!0):this.getRoomDataRef(e).once("value").then((function(e){var t=null!==e.val();return Promise.resolve(t)}))}};Object.assign(Ae,Me);var Oe=function(){function e(r){t(this,e);var i=F(r,"eventEmitter",void 0),n=F(r,"EventEmitterClass",void 0);this.setEventEmitter(i,n),this.database=firebase.database(),this.rootPath=F(r,"root",""),this.userInfo={userID:"",userName:""},this.setUser(F(r,"userID",""),F(r,"userName","")),this.isRoomCreator=!1,this.roomID=void 0,this.roomName=void 0,this.roomType=void 0,this.doorState=void 0,this.leftRoomFlag=!1,this.isRemoveRoomWhenLeft=void 0,this.userList=ie.call(this,r),this.roomList=se.call(this,r),this.broadcast=oe.call(this,r),this.tables=be.call(this,r);}return i(e,[{key:"shutdown",value:function(){var e=this;this.destroyEventEmitter().leaveRoom().then((function(){e.userList.destroy(),e.userList=void 0,e.roomList.destroy(),e.roomList=void 0,e.broadcast.destroy(),e.broadcast=void 0;}));}},{key:"destroy",value:function(){this.shutdown();}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e;}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e;}},{key:"getRoomInfo",value:function(e,t){return void 0===e&&(e=this.roomID),void 0===t&&(t=this.roomName),{roomID:e,roomName:t}}},{key:"setUser",value:function(e,t){return U(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"isInRoom",value:function(e){return void 0===e?void 0!==this.roomID:this.roomID===e}},{key:"isFull",value:function(){return this.userList.isFull()}},{key:"isFirstUser",value:function(e){return this.userList.isFirstUser(e)}},{key:"getUsers",value:function(){return this.userList.getUsers()}},{key:"maxUsers",get:function(){return this.userList.maxUsers}},{key:"getTable",value:function(e){return this.tables[e]}}]),e}();Object.assign(Oe.prototype,N,Ae),P.register("room",(function(e){return new Oe(e)})),Q(window,"RexPlugins.Fire.Room",Oe);var Qe=function(e){var t=new te({eventEmitter:this.getEventEmitter(),eventNames:{join:"userlist.join",leave:"userlist.leave",update:"userlist.update",change:"userlist.change",init:"userlist.init",changename:"userlist.changename"},root:this.getUserListPath(),userID:this.userInfo,maxUsers:F(e,"maxUsers",0)});return t.on("userlist.leave",(function(e){e.userID===this.userID&&Te.call(this);}),this),this.on("room.join",(function(){t.startUpdate();})).on("room.leave",(function(){t.stopUpdate().clear();})),t},Te=function(){this.emit("room.leave");var e=this;setTimeout((function(){e.leftRoomFlag=!1;}),0);},Se=function(e){var t=F(e,"broadcast",!0);if(!t)return null;var r=new j({eventEmitter:this.getEventEmitter(),eventNames:{receive:"broadcast.receive"},root:this.rootPath,receiverID:"broadcast",senderID:this.userInfo,history:F(t,"history",!1)});return this.on("room.join",(function(){r.startReceiving();})).on("room.leave",(function(){r.stopReceiving();})).on("userlist.changename",(function(e,t){r.changeUserName(e,t);}),this),r},Be=function(e){var t,r=F(e,"tables",void 0);if(void 0===r)return {};for(var i={},n=0,s=r.length;n<s;n++)i[(t=r[n]).key]=Ke.call(this,t);return i},Ke=function(e){var t=e.key,r=new ge({eventEmitter:this.getEventEmitter(),root:this.getItemTablePath(t),type:F(e,"type",1),eventNames:{init:"tables.".concat(t,".init"),update:"tables.".concat(t,".update"),addkey0:"tables.".concat(t,".addkey0"),removekey0:"tables.".concat(t,".removekey0"),changekey0:"tables.".concat(t,".changekey0"),addkey1:"tables.".concat(t,".addkey1"),removekey1:"tables.".concat(t,".removekey1"),changekey1:"tables.".concat(t,".changekey1"),addkey2:"tables.".concat(t,".addkey2"),removekey2:"tables.".concat(t,".removekey2"),changekey2:"tables.".concat(t,".changekey2")}});return this.on("room.join",(function(){r.startUpdate();})).on("room.leave",(function(){r.clear().stopUpdate();})),r},qe={joinRoom:function(){var e=this;return this.userList.join().then((function(){return e.emit("room.join"),Promise.resolve()}))},leaveRoom:function(){return this.isInRoom()?(this.leftRoomFlag=!0,this.userList.leave()):Promise.resolve()},kickUser:function(e){return this.userList.contains(e)?e===this.userID?this.leaveRoom():this.userList.leave(e):Promise.resolve()},changeUserName:function(e){return this.userList.changeUserName(e)},getUserList:function(){return this.userList.getUsers()}};Object.assign(qe,{getRoomRef:function(e){var t=this.database.ref(this.rootPath);return e&&(t=t.child(e)),t},getUserListRef:function(){return this.getRoomRef("users")},getRoomDataPath:function(e){var t=this.rootPath;return e&&(t+="/".concat(e)),t},getUserListPath:function(){return this.getRoomDataPath("users")},getItemTablePath:function(e){return "".concat(this.getRoomDataPath("tables"),"/").concat(e)}});var ze=function(){function e(r){t(this,e);var i=F(r,"eventEmitter",void 0),n=F(r,"EventEmitterClass",void 0);this.setEventEmitter(i,n),this.database=firebase.database(),this.rootPath=F(r,"root",""),this.userInfo={userID:"",userName:""},this.setUser(F(r,"userID",""),F(r,"userName","")),this.leftRoomFlag=!1,this.userList=Qe.call(this,r),this.broadcast=Se.call(this,r),this.tables=Be.call(this,r);}return i(e,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown();}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e;}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e;}},{key:"setUser",value:function(e,t){return U(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"isInRoom",value:function(){return this.userList.isInList}},{key:"isFull",value:function(){return this.userList.isFull()}},{key:"isFirstUser",value:function(e){return this.userList.isFirstUser(e)}},{key:"getUsers",value:function(){return this.userList.getUsers()}},{key:"maxUsers",get:function(){return this.userList.maxUsers}},{key:"getTable",value:function(e){return this.tables[e]}}]),e}();Object.assign(ze.prototype,N,qe),P.register("singleRoom",(function(e){return new ze(e)})),Q(window,"RexPlugins.Fire.SingleRoom",ze),P.register("itemTable",(function(e){return new ge(e)})),Q(window,"RexPlugins.Fire.ItemTable",ge);var He=function(e){return void 0===e.totalLines&&(e.totalLines=1/0),void 0===e.linesPerPage&&(e.linesPerPage=1e3),e.remainderLines=e.totalLines,Ve(e)},Ve=function e(t){var r=t.query;t.startDocRef&&(r=r[t.startMode](t.startDocRef));var i=Math.min(t.remainderLines,t.linesPerPage);return t.remainderLines-=i,r.limit(i).get().then((function(r){var n,s=0===t.remainderLines||r.size<i;return t.forEachPageCallback&&(s|=!!t.forEachPageCallback(r)),s?(t.resolveCallback&&(n=t.resolveCallback()),Promise.resolve(n)):(t.startDocRef=r.docs[r.size-1],t.startMode="startAfter",e(t))}))},We=function(e,t,r,i,n){void 0===t&&(t=1/0),void 0===r&&(r=0);var s=[],o=0;return He({query:e,totalLines:r+t,startDocRef:i,startMode:n,forEachPageCallback:function(e){var t,i=e.size,n=r-o;n<=0?t=e.docs:n<i&&(t=e.docs.slice(n,i)),t&&s.push.apply(s,h(t)),o+=i;},resolveCallback:function(){return s}})},Ye=function(){var e=this;return We(this.nextQuery,this.itemCount,0,this.baselineDocRef,this.baselineMode).then((function(t){var r=t.length;return e.cacheItems=t,e.pageIndex=0,e.startItemIndex=0,e.endItemIndex=e.startItemIndex+r-1,e.isFullPage=r===e.itemCount,e.prevPageEndDocRef=void 0,e.currPageStartDocRef=t[0],e.currPageEndDocRef=t[r-1],Promise.resolve(e.cacheItems)}))},Ge=function(){var e=this;return We(this.nextQuery,this.itemCount,0,this.baselineDocRef,this.baselineMode).then((function(t){var r=t.length;return e.cacheItems=t,e.pageIndex=0,e.startItemIndex=0,e.endItemIndex=e.startItemIndex+r-1,e.isFullPage=r===e.itemCount,Promise.resolve(e.cacheItems)}))},Je=function(){var e=this;return We(this.nextQuery,this.itemCount,0,this.currPageEndDocRef,"startAfter").then((function(t){var r=t.length;return e.cacheItems=t,e.pageIndex+=1,e.startItemIndex=e.endItemIndex+1,e.endItemIndex=e.startItemIndex+r-1,e.isFullPage=r===e.itemCount,e.prevPageEndDocRef=e.currPageEndDocRef,e.currPageStartDocRef=t[0],e.currPageEndDocRef=t[r-1],Promise.resolve(e.cacheItems)}))},Xe=function(){var e=(this.pageIndex+1)*this.itemCount,t=this;return We(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then((function(e){var r=e.length;return t.cacheItems=e,t.pageIndex+=1,t.startItemIndex=t.endItemIndex+1,t.endItemIndex=t.startItemIndex+r-1,t.isFullPage=r===t.itemCount,Promise.resolve(t.cacheItems)}))},Ze=function(){var e=this;return We(this.prevQuery,this.itemCount+1,0,this.currPageStartDocRef,"startAfter").then((function(t){var r=t.length-1;return e.cacheItems=t,e.cacheItems.pop(),e.cacheItems.reverse(),e.pageIndex-=1,e.endItemIndex=e.startItemIndex-1,e.startItemIndex=e.endItemIndex-r+1,e.isFullPage=r===e.itemCount,e.prevPageEndDocRef=t[r],e.currPageStartDocRef=t[r-1],e.currPageEndDocRef=t[0],Promise.resolve(e.cacheItems)}))},$e=function(){var e=(this.pageIndex-1)*this.itemCount,t=this;return We(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then((function(e){var r=e.length;return t.cacheItems=e,t.pageIndex-=1,t.endItemIndex=t.startItemIndex-1,t.startItemIndex=t.endItemIndex-r+1,t.isFullPage=r===t.itemCount,Promise.resolve(t.cacheItems)}))},et=function(){var e=this;return We(this.nextQuery,this.itemCount,0,this.prevPageEndDocRef,"startAfter").then((function(t){var r=t.length;return e.cacheItems=t,e.endItemIndex=e.startItemIndex+r-1,e.isFullPage=r===e.itemCount,e.currPageStartDocRef=t[0],e.currPageEndDocRef=t[r-1],Promise.resolve(e.cacheItems)}))},tt=function(){var e=this.pageIndex*this.itemCount,t=this;return We(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then((function(e){var r=e.length;return t.cacheItems=e,t.endItemIndex=t.startItemIndex+r-1,t.isFullPage=r===t.itemCount,Promise.resolve(t.cacheItems)}))},rt=function(){function e(r){t(this,e),this.setItemCount(F(r,"itemCount",100)),this.setQuery(F(r,"query",void 0)),this.setDataMode(F(r,"dataMode",0)),this.setBaselineDoc(F(r,"baselineDoc",void 0),F(r,"baselineMode",void 0)),this.pageIndex=void 0,this.baselineDocRef=void 0,this.baselineMode="startAt",this.startItemIndex=void 0,this.endItemIndex=void 0,this.cacheItems=void 0,this.isFullPage=void 0;}return i(e,[{key:"setItemCount",value:function(e){return this.itemCount=e,this}},{key:"setQuery",value:function(e,t){if(U(e)){var r=e;this.nextQuery=r.next,this.prevQuery=r.previous;}else this.nextQuery=e,this.prevQuery=t;return this.pageIndex=void 0,this.isFullPage=void 0,this}},{key:"setDataMode",value:function(e){return "string"==typeof e&&(e=nt[e]),this.dataMode=e,this}},{key:"setBaselineDoc",value:function(e,t){return e?(this.baselineDocRef=e.ref,this.baselineMode=t):this.baselineDocRef=void 0,this}}]),e}(),it={loadFirstPage:function(){return (0===this.dataMode?Ye:Ge).call(this)},loadNextPage:function(){return void 0===this.pageIndex?this.loadFirstPage():(0===this.dataMode?Je:Xe).call(this)},loadPreviousPage:function(){return void 0===this.pageIndex||1===this.pageIndex?this.loadFirstPage():(0===this.dataMode?Ze:$e).call(this)},loadCurrentPage:function(){return void 0===this.pageIndex||0===this.pageIndex?this.loadFirstPage():(0===this.dataMode?et:tt).call(this)},load:function(e,t){void 0===t&&(t=0);var r=this;return We(this.nextQuery,e,t,this.baselineDocRef,this.baselineMode).then((function(i){var n=i.length;return r.cacheItems=i,r.pageIndex=void 0,r.startItemIndex=t,r.endItemIndex=r.startItemIndex+n-1,r.isFullPage=void 0===e||n===e,Promise.resolve(r.cacheItems)}))}};Object.assign(rt.prototype,it);var nt={static:0,dynamic:1};P.register("pageLoader",(function(e){return new rt(e)})),Q(window,"RexPlugins.Fire.PageLoader",rt);var st=function(e){var t=e.data();return t.headerDocID=e.id,t},ot=function(e){var t=this.userID,r=this.cacheHeaders[e];if(r&&r.userID===t)return Promise.resolve(r);var i=this;return this.getFileQuery(t,e,"header").limit(1).get().then((function(t){var r=void 0;if(t.size>0){var n=t.docs[0];r=st(n),i.cacheHeaders[e]=r;}return Promise.resolve(r)}))},at=function(){function e(r){t(this,e),this.database=firebase.firestore(),this.setRootPath(F(r,"root","")),this.cacheHeaders={},this.userInfo={userID:""},this.setOwner(F(r,"userID",""));}return i(e,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown();}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e;}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setOwner",value:function(e){var t=this.userID;return U(e)?this.userInfo=e:this.userID=e,t!==this.userID&&this.clearCache(),this}},{key:"clearCache",value:function(){return f(this.cacheHeaders),this}},{key:"getFileQuery",value:function(e,t,r){var i=this.rootRef;return i=e?i.where("userID","==",e):i,i=t?i.where("fileID","==",t):i,i=r?i.where("type","==",r):i}}]),e}(),ut={save:function(e,t,r,i){"boolean"==typeof r&&(i=r,r=void 0),void 0===i&&(i=!1);var n=this.userID;void 0===t&&(t={}),t.userID=n,t.fileID=e,t.type="header",r&&(r.userID=n,r.fileID=e,r.type="content");var s=i?"update":"set",o=this;return ot.call(this,e).then((function(e){var i,n;e?(i=o.rootRef.doc(e.headerDocID),r&&(n=e.contentDocID?o.rootRef.doc(e.contentDocID):o.rootRef.doc())):(i=o.rootRef.doc(),r&&(n=o.rootRef.doc())),t.hasOwnProperty("headerDocID")&&delete t.headerDocID,n&&(t.contentDocID=n.id);var a=o.database.batch();return a[s](i,t),r&&a[s](n,r),a.commit()})).then((function(){return Promise.resolve({userID:n,fileID:e})})).catch((function(t){return Promise.reject({error:t,userID:n,fileID:e})}))},load:function(e){var t=this.userID;return this.getFileQuery(t,e).get().then((function(r){var i,n;return r.forEach((function(e){switch(docData.type){case"header":i=st(e);break;case"content":n=e.data();}})),Promise.resolve({userID:t,fileID:e,header:i,content:n})})).catch((function(){return Promise.reject({error:error,userID:t,fileID:e})}))},loadHeaders:function(){var e=this.userID,t=this;return this.getFileQuery(e,void 0,"header").get().then((function(r){var i;return f(t.cacheHeaders),r.forEach((function(e){i=st(e),t.cacheHeaders[i.fileID]=i;})),Promise.resolve({userID:e,headers:t.cacheHeaders})})).catch((function(){return Promise.reject({error:error,userID:e})}))},delete:function(e){var t=this.userID,r=this;return LoadHeader.call(this,e).then((function(i){if(!i)return Promise.resolve({userID:t,fileID:e});var n=r.database.batch();return n.delete(r.rootRef.doc(i.headerDocID)),i.contentDocID&&n.delete(r.rootRef.doc(i.contentDocID)),n.commit()})).then((function(){return r.cacheHeaders.hasOwnProperty(e)&&delete r.cacheHeaders[e],Promise.resolve({userID:t,fileID:e})})).catch((function(r){return Promise.reject({error:r,userID:t,fileID:e})}))},clear:function(){var e=this.userID,t=this;return this.getFileQuery(e,void 0,"header").get().then((function(e){var r,i=t.database.batch();return e.forEach((function(e){r=DocToHeader(e),i.delete(t.rootRef.doc(r.headerDocID)),r.contentDocID&&i.delete(t.rootRef.doc(r.contentDocID));})),i.commit()})).then((function(){return t.clearCache(),Promise.resolve({userID:e})})).catch((function(t){return Promise.reject({error:t,userID:e})}))}};Object.assign(at.prototype,ut),P.register("files",(function(e){return new at(e)})),Q(window,"RexPlugins.Fire.Files",at);var ht=function(e,t){var r=this;return this.database.runTransaction((function(i){var n=r.getAliasRef(t);return i.get(n).then((function(r){return r.exists?Promise.reject({id:e,alias:t}):(i.set(n,{id:e}),Promise.resolve({id:e,alias:t}))}))}))},ct=function e(t,r,i,n){var s=Ue(r,r,i);if(n<=0)return Promise.reject({id:t,alias:s});n--;var o=this;return ht.call(o,t,s).catch((function(){setTimeout((function(){return e.call(o,t,r,i,n)}),0);}))},lt=function(){function e(r){t(this,e),this.database=firebase.firestore(),this.setRootPath(F(r,"root",""));}return i(e,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown();}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"getAliasRef",value:function(e){return this.rootRef.doc(e)}}]),e}(),ft={add:function(e,t){var r=this;return this.getAlias(e).then((function(i){return i.alias?i.alias===t?Promise.resolve({id:e,alias:t}):Promise.reject({id:e,alias:t}):ht.call(r,e,t)}))},addRandom:function(e,t){var r=F(t,"digits",10),i=F(t,"candidates","0123456789"),n=F(t,"retry",1e3),s=this;return this.getAlias(e).then((function(t){if(t.alias){var o=Ue(r,r,i);return t.alias===o?Promise.resolve({id:e,alias:o}):Promise.reject({id:e,alias:o})}return ct.call(s,e,r,i,n)}))},getId:function(e){return this.getAliasRef(e).get().then((function(t){var r;return t.exists&&(r=t.data().id),Promise.resolve({id:r,alias:e})}))},getAlias:function(e){return this.rootRef.where("id","==",e).limit(1).get().then((function(t){var r;t.size>0&&(r=t.docs[0].id);return Promise.resolve({id:e,alias:r})}))},getRandomAlias:function(e,t){var r=F(t,"digits",10),i=F(t,"candidates","0123456789"),n=F(t,"retry",1e3),s=this;return this.getAlias(e).then((function(t){return t.alias?Promise.resolve(t):ct.call(s,e,r,i,n)}))},remove:function(e){var t=this;return this.getAlias(e).then((function(e){return t.getAliasRef(e).delete()}))}};Object.assign(lt.prototype,ft),P.register("idAlias",(function(e){return new lt(e)})),Q(window,"RexPlugins.Fire.IdAlias",lt);var vt=function(e){var t=e?new Date(e):new Date,r=t.getFullYear(),i=t.getMonth()+1,n=t.getDate(),s=new Date(t.getFullYear(),0,1),o=Math.ceil(((t-s)/864e5+s.getDay()+1)/7);return {d:"".concat(r,"-").concat(i,"-").concat(n),w:"".concat(r,"-").concat(o),m:"".concat(r,"-").concat(i),y:"".concat(r),a:""}},dt={d:"tagD",w:"tagW",m:"tagM",y:"tagY",a:"tagA"},mt={d:"scoreD",w:"scoreW",m:"scoreM",y:"scoreY",a:"scoreA"},yt={loadFirstPage:function(){this.resetPageQuery();var e=this;return this.page.loadFirstPage().then((function(t){return Promise.resolve(gt.call(e,t))}))},loadNextPage:function(){this.resetPageQuery();var e=this;return this.page.loadNextPage().then((function(t){return Promise.resolve(gt.call(e,t))}))},loadPreviousPage:function(){this.resetPageQuery();var e=this;return this.page.loadPreviousPage().then((function(t){return Promise.resolve(gt.call(e,t))}))},loadCurrentPage:function(){this.resetPageQuery();var e=this;return this.page.loadCurrentPage().then((function(t){return Promise.resolve(gt.call(e,t))}))},load:function(e,t){this.resetPageQuery();var r=this;return this.page.load(e,t).then((function(e){return Promise.resolve(gt.call(r,e))}))},resetPageQuery:function(){return this.resetQueryFlag?(this.resetQueryFlag=!1,this.page.setQuery(this.getPageQuery()),this):this}},gt=function(e){for(var t,r=[],i=mt[this.timeFilterType[0]],n=0,s=e.length;n<s;n++){if(t=e[n].data(),!1!==this.timeFilters)for(var o in t.score=t[i],this.timeFilters)delete t[dt[o]],delete t[mt[o]];r.push(t);}return r},pt=function(e){return We(e).then((function(e){if(0===e.length)return Promise.resolve();for(var t,r,i=[],n=0,s=e.length;n<s;n++)void 0===t&&(t=firebase.firestore().batch(),r=0),t.delete(e[n].ref),++r>=500&&(i.push(t.commit()),t=void 0);return t&&i.push(t.commit()),Promise.all(i)}))},It={deleteUser:function(e){void 0===e&&(e=this.userID);var t=this.getRecordQuery(void 0,void 0,e,void 0);return pt(t)},deleteBoard:function(e,t){void 0===e&&(e=this.boardID),void 0===t&&(t=this.tag);var r=this.getRecordQuery(e,t,void 0,void 0);return pt(r)}},Dt={getRecordQuery:function(e,t,r,i){var n=this.rootRef;return n=void 0!==e?n.where("boardID","==",e):n,n=void 0!==t?n.where("tag","==",t):n,n=void 0!==r?n.where("userID","==",r):n,void 0!==i&&(n=n.where(i[0],"==",i[1])),n},getMyRecordQuery:function(e){return void 0===e&&(e=this.userID),this.getRecordQuery(this.boardID,this.tag,e,void 0).limit(1)},getPageQuery:function(){var e,t;if(!1!==this.timeFilters){var r=this.timeFilterType[0];e=[dt[r],vt()[r]],t=mt[r];}else e=void 0,t="score";var i=this.getRecordQuery(this.boardID,this.tag,void 0,e);return {next:i.orderBy(t,"desc"),previous:i.orderBy(t)}}},kt=function(){function e(r){t(this,e),this.database=firebase.firestore(),this.setRootPath(F(r,"root","")),this.userInfo={userID:void 0,userName:void 0},this.setUser(F(r,"userID",""),F(r,"userName",void 0)),this.setBoardID(F(r,"boardID",void 0)),this.setTag(F(r,"tag",void 0)),this.setTimeFilters(F(r,"timeFilters",!1)),this.setTimeFilterType(F(r,"timeFilterType","year")),this.page=new rt({dataMode:"dynamic",itemCount:F(r,"pageItemCount",100)}),this.resetQueryFlag=!0;}return i(e,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown();}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e;}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e;}},{key:"setRootPath",value:function(e){return this.resetQueryFlag|=this.rootPath!==e,this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setUser",value:function(e,t){return U(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setBoardID",value:function(e){return this.resetQueryFlag|=this.boardID!==e,this.boardID=e,this}},{key:"setTag",value:function(e){return this.resetQueryFlag|=this.tag!==e,this.tag=e,this}},{key:"setTimeFilters",value:function(e){return this.timeFilters=!1!==e&&{d:F(e,"day",!0),w:F(e,"week",!0),m:F(e,"month",!0),y:F(e,"year",!0),a:F(e,"all",!0)},this}},{key:"setTimeFilterType",value:function(e){return this.resetQueryFlag|=this.timeFilterType!==e,this.timeFilterType=e,this}},{key:"setPageItemCount",value:function(e){return this.page.setItemCount(e),this}},{key:"pageIndex",get:function(){return this.page.pageIndex}},{key:"isFirstPage",get:function(){return 0===this.page.pageIndex}},{key:"isLastPage",get:function(){return !1===this.page.isFullPage}}]),e}(),bt={post:function(e,t,r){var i={userID:this.userID};void 0!==this.boardID&&(i.boardID=this.boardID),this.userName&&(i.userName=this.userName);var n=vt(r);if(!1!==this.timeFilters)for(var s in this.timeFilters)this.timeFilters[s]&&(i[dt[s]]=n[s],i[mt[s]]=e);else i.score=e;this.tag&&(i.tag=this.tag),t&&Object.assign(i,t);var o=this;return this.getMyRecordQuery().get().then((function(e){var t,r;if(e.size>0){var n=e.docs[0];t=n.data(),r=n.id;}if(t)if(!1!==o.timeFilters){for(var s in o.timeFilters)if(o.timeFilters[s]){var a=dt[s];if(t[a]===i[a]){var u=mt[s];i[u]=Math.max(t[u],i[u]);}}}else i.score=Math.max(t.score,i.score);return void 0===r&&(r=o.rootRef.doc().id),o.rootRef.doc(r).set(i)}))},getScore:function(e){return this.getMyRecordQuery(e).get().then((function(e){var t;e.size>0&&(t=e.docs[0].data());return Promise.resolve(t)}))},getRank:function(e){void 0===e&&(e=this.userID);return function(e,t){var r={doc:void 0,index:void 0},i=0;return He({query:e,forEachPageCallback:function(e){for(var n,s=e.docs,o=0,a=s.length;o<a;o++)if(n=s[o],t(n))return r.doc=n,r.index=i+o,!0;i+=e.size;},resolveCallback:function(){return r}})}(this.getPageQuery().next,(function(t){return t.data().userID===e})).then((function(t){return Promise.resolve({userID:e,rank:t.index})}))}};Object.assign(kt.prototype,bt,Dt,yt,It),P.register("leaderBoard",(function(e){return new kt(e)})),Q(window,"RexPlugins.Fire.LeaderBoard",kt);var Rt={startReceiving:function(){var e=this.getReceiverQuery(this.receiverID).orderBy("timestamp","desc").limit(1),t=this;return this.unsubscribe=e.onSnapshot({includeMetadataChanges:!0},(function(e){if(e.size>0){var r=e.docs[0];if(r.metadata.hasPendingWrites)return void(t.skipFirst&&(t.skipFirst=!1));if(t.resetPageQuery(t.receiverID,r),t.skipFirst)t.skipFirst=!1;else {var i=Pt(r);t.cacheMessages.push(i),t.emit("receive",i);}}else t.skipFirst&&(t.skipFirst=!1);}),(function(e){})),this},stopReceiving:function(){return this.unsubscribe&&this.unsubscribe(),this.resetQueryFlag=!0,this.cacheMessages.length=0,this},loadPreviousMessages:function(){this.resetPageQuery(this.receiverID);var e=this;return this.page.loadNextPage().then((function(t){for(var r,i=[],n=0,s=t.length;n<s;n++)i.push(Pt(t[n]));return (r=e.cacheMessages).splice.apply(r,[0,0].concat(i)),Promise.resolve(i)}))},resetPageQuery:function(e,t){if(!this.resetQueryFlag)return this;this.resetQueryFlag=!1;var r=this.skipFirst?"startAt":"startAfter";return this.page.setBaselineDoc(t,r).setQuery(this.getPageQuery(e)),this}},Pt=function(e){var t=e.data();return t.timestamp=1e3*t.timestamp.seconds,t},wt={getReceiverQuery:function(e){void 0===e&&(e=this.receiverID);var t=this.rootRef;return t=void 0!==e?t.where("receiverID","==",e):t},getPageQuery:function(e){var t=this.getReceiverQuery(e);return {next:t.orderBy("timestamp"),previous:t.orderBy("timestamp","desc")}}},Et=function(){function e(r){t(this,e);var i=F(r,"eventEmitter",void 0),n=F(r,"EventEmitterClass",void 0);this.setEventEmitter(i,n),this.database=firebase.firestore(),this.setRootPath(F(r,"root","")),this.userInfo={userID:"",userName:void 0},this.setSender(F(r,"senderID",""),F(r,"senderName","")),this.setReceiver(F(r,"receiverID",void 0)),this.skipFirst=!0,this.unsubscribe=void 0,this.page=new rt,this.setPageItemCount(F(r,"pageItemCount",100)),this.resetQueryFlag=!0,this.cacheMessages=[];}return i(e,[{key:"shutdown",value:function(){this.stopReceiving().destroyEventEmitter();}},{key:"destroy",value:function(){this.shutdown();}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e;}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e;}},{key:"setRootPath",value:function(e){return this.resetQueryFlag|=this.rootPath!==e,this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setSender",value:function(e,t){return U(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setReceiver",value:function(e){return this.resetQueryFlag|=this.receiverID!==e,this.receiverID=e,this}},{key:"setPageItemCount",value:function(e){return this.page.setItemCount(e),this}},{key:"hasPreviousMessage",get:function(){return !1!==this.page.isFullPage}}]),e}(),xt={send:function(e){var t={senderID:this.userID,message:e,timestamp:firebase.firestore.FieldValue.serverTimestamp()};return void 0!==this.userName&&(t.senderName=this.userName),void 0!==this.receiverID&&(t.receiverID=this.receiverID),this.rootRef.add(t)}};return Object.assign(Et.prototype,N,xt,Rt,wt),P.register("messages",(function(e){return new Et(e)})),Q(window,"RexPlugins.Fire.Messages",Et),function(e){n(s,Phaser.Plugins.BasePlugin);var r=u(s);function s(e){var i;return t(this,s),(i=r.call(this,e)).add=new P,i}return i(s,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this);}},{key:"initializeApp",value:function(e){return this.add.initializeApp(e),this}},{key:"preload",value:function(e,t,r){return R.call(e.sys.load,t,r),this}}]),s}()}));
